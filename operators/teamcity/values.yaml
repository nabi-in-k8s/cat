database:
  enabled: false
  nameOverride: "database"

  image:
    repository: postgres
    tag: latest

  deployment:
    create: true
    securityContext:
      runAsUser: 1000

  container:
    securityContext:
      fsGroup: 1000
      livenessProbe:
        exec:
          command: ["psql", "-U", "\"${$POSTGRES_USER}\"", "-d", "\"${$POSTGRES_DB}\"", "-c", "SELECT 1"]
        initialDelaySeconds: 15
        timeoutSeconds: 2
      readinessProbe:
        exec:
          command: ["psql", "-U", "\"${$POSTGRES_USER}\"", "-d", "\"${$POSTGRES_DB}\"", "-c", "SELECT 1"]
        initialDelaySeconds: 45
        timeoutSeconds: 2
    env:
      - name: POSTGRES_USER
        valueFrom:
          secretKeyRef:
            name: teamcity-postgres-secret
            key: username
      - name: POSTGRES_PASSWORD
        valueFrom:
          secretKeyRef:
            name: teamcity-postgres-secret
            key: password
      - name: POSTGRES_DB
        valueFrom:
          secretKeyRef:
            name: teamcity-postgres-secret
            key: database
      - name: PG_DATA
        value: /var/lib/postgresql/data

  service:
    create: true
    ports:
      - name: postgres
        port: 5432
        protocol: TCP

  storageClass:
    create: true

  persistentVolumes:
    - name: data
      storageSize: 1Gi
      accessModes:
        - ReadWriteMany
      size: 1Gi
      path: "/data/teamcity/postgres"
      claim:
        create: true

  volumes:
    - name: psql-data
      persistentVolumeClaim:
        claimName: data

  volumeMounts:
    - name: psql-data
      mountPath: "/var/lib/postgresql/data"

server:
  enabled: false
  nameOverride: "server"

  image:
    repository: jetbrains/teamcity-server
    tag: 2024.07.1-linux-sudo

  deployment:
    create: true
    securityContext:
      runAsUser: 1000

  container:
    securityContext:
      fsGroup: 1000
    livenessProbe:
      httpGet:
        path: /
        port: teamcity
      initialDelaySeconds: 300
      timeoutSeconds: 2
    readinessProbe:
      httpGet:
        path: /
        port: teamcity
      initialDelaySeconds: 300
      timeoutSeconds: 2

  volumes:
    - name: server-config
      persistentVolumeClaim:
        claimName: server-config

  volumeMounts:
    - name: server-config
      mountPath: /data/teamcity_server/datadir

  service:
    create: true
    ports:
      - name: teamcity
        port: 8111
        protocol: TCP

  ingress:
    create: true
    annotations:
      kubernetes.io/tls-acme: "true"
      kubernetes.io/ingress.class: nginx
    hosts:
      - host: ""
        paths:
          - path: /
            pathType: Prefix
            svcPort:
              name: teamcity
              port: 8111
    tls:
      - secretName: teamcity-server-tls
        hosts:
          - ""

  persistentVolumes:
    - name: server-config
      storageSize: 1Gi
      accessModes:
        - ReadWriteMany
      size: 1Gi
      path: "/data/teamcity/server"
      claim:
        create: true

agent-0:
  enabled: false
  nameOverride: "agent-0"

  replicas: 1

  image:
    repository: jetbrains/teamcity-agent
    tag: 2024.07.1-linux-sudo

  deployment:
    create: true
    securityContext:
      fsGroup: 1000

  container:
    securityContext:
      runAsUser: 1000
    env:
      - name: SERVER_URL
        value: "http://teamcity-server:8111"
      - name: DOCKER_IN_DOCKER
        value: "true"

  service:
    create: true
    ports:
      - name: teamcity
        port: 9090
        target: 9090

  volumes:
    - name: agent-config
      persistentVolumeClaim:
        claimName: agent-config

  volumeMounts:
    - name: agent-config
      subPath: agent-0
      mountPath: /data/teamcity_agent/conf

  persistentVolumes:
    - name: agent-config
      storageSize: 1Gi
      accessModes:
        - ReadWriteMany
      size: 1Gi
      claim:
        create: true

agent-1:
  enabled: false
  nameOverride: "agent-1"

  replicas: 1

  image:
    repository: jetbrains/teamcity-agent
    tag: 2024.07.1-linux-sudo

  deployment:
    create: true
    securityContext:
      fsGroup: 1000

  container:
    securityContext:
      runAsUser: 1000
    env:
      - name: SERVER_URL
        value: "http://teamcity-server:8111"
      - name: DOCKER_IN_DOCKER
        value: "true"

  service:
    create: true
    ports:
      - name: teamcity
        port: 9091
        target: 9090

  volumes:
    - name: agent-config
      persistentVolumeClaim:
        claimName: agent-config

  volumeMounts:
    - name: agent-config
      subPath: agent-1
      mountPath: /data/teamcity_agent/conf

  persistentVolumes:
    - name: agent-config
      storageSize: 1Gi
      accessModes:
        - ReadWriteMany
      size: 1Gi
      claim:
        create: true

agent-2:
  enabled: false
  nameOverride: "agent-2"

  replicas: 1

  image:
    repository: jetbrains/teamcity-agent
    tag: 2024.07.1-linux-sudo

  deployment:
    create: true
    securityContext:
      fsGroup: 1000

  container:
    securityContext:
      runAsUser: 1000
    env:
      - name: SERVER_URL
        value: "http://teamcity-server:8111"
      - name: DOCKER_IN_DOCKER
        value: "true"

  service:
    create: true
    ports:
      - name: teamcity
        port: 9092
        target: 9090

  volumes:
    - name: agent-config
      persistentVolumeClaim:
        claimName: agent-config

  volumeMounts:
    - name: agent-config
      subPath: agent-2
      mountPath: /data/teamcity_agent/conf

  persistentVolumes:
    - name: agent-config
      storageSize: 1Gi
      accessModes:
        - ReadWriteMany
      size: 1Gi
      claim:
        create: true
